---
title: "The balance of nature relies on response diversity for stability"
author: "Til HÃ¤mmig, Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
    keep_md: yes
    fig_caption: true  
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
rm(list=ls())
library("ggplot2")
library("tidyverse")
library("gridExtra")
#library(rEDM)
library("parallel")
library("pracma")
library("purrr")
library("signal")
library("ggfortify")
library("data.table")
library("patchwork")
library("codyn")
library("ggrepel")
library("lme4")
library("lmerTest")
library("MuMIn")
library("RColorBrewer")
library("broom")
library("relaimpo")
library("lavaanPlot")
library(ggbeeswarm)
library(performance)
#devtools::install_github("canankarakoc/r_package_EDMhelper/EDMhelper")

```

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```


# Introduction

The purpose of this document is to provide a reproducible record of all analyses and figures in the main article. The main article is focused on the effect of response diversity on community stability in fluctuating environments. We are going to look at the effect of response diversity, richness, temperature and nutrients on community temporal stability. Specifically, we are going to look at the effect of fundamental balance (our measurement of stability) on temporal stability. Then, as response diversity is thought to stabilize temporal stability of aggregate community properties via asynchrony, we are going to look at the relationship between response diversity and asynchrony. 
Finally, as multiple evidence suggests that compensatory dynamics and temporal stability are determine by species interactions, we are going to analyse the effect of species interactions on stability to understand if they are more important than response diversity in driving temporal stability of community biomass.

This document is produced by an Rmarkdown file that includes code to reproduce from data all results presented in the main article.



# Load datasets

```{r results='hide', echo=FALSE, warning=FALSE}

divergence_df <- read_csv("Data/divergence_df.csv")
load("Data/dens_biomass_poly.RData")

dd_all_pred<-read.csv("Data/morph_dd_pred.csv")
dd_all_pred_nonoise<-read.csv("Data/morph_dd_pred_nonoise.csv")

load("Data/ciliate_traits.Rdata")

df_slopes <- read_csv("Data/df_slopes_cor.csv")
```
## Data wrangling and balance calculation


```{r echo=T, include=T, warning=FALSE, results='hide'}
# needs to have id_new variable
ciliate_traits <- ciliate_traits %>%
  dplyr::mutate(
    # Remove dots from the date
    cleaned_date = gsub("\\.", "", date),
    # Extract the part of id after the underscore
    id_suffix = sub(".*_(.*)", "\\1", id),
    # Combine cleaned_date, id_suffix, and species_initial into a new variable
    id_new = paste0(cleaned_date, id_suffix, composition)
  ) %>%
  # Optionally, remove the intermediate columns to clean up
  dplyr::select(-cleaned_date, -id_suffix,-new_id)

uniqueN(ciliate_traits$id_new)==nrow(ciliate_traits) # all unique  ;)

id_dd<-full_join(dd_all_pred,dplyr::select(ciliate_traits,id_new,biomass),join_by("id_new"))


## add day variable

#create a day variable from the date variable

id_dd<-dplyr::mutate(id_dd,date=as.Date(date,format = "%d.%m.%y"))

earliest_date<-min(id_dd$date)
days_since_earliest<-as.numeric(id_dd$date-earliest_date)+1
id_dd<-id_dd%>%dplyr::mutate(day=days_since_earliest)

#create a summarised df on microcosm level with each species seperate
# Make sure, that we have n_frames and not N_frames
names(id_dd)[names(id_dd) == "N_frames"] <- "n_frames"

#extrapolation_factor <- 9.301902  # for 16 x magnification 
extrapolation_factor <- 9.828125  # for 25 x magnification 
video_biomass_species <- c( "C", "P", "S","D","L","T")

biomasses <- id_dd %>%
  dplyr::group_by( day,temperature,nutrients,sample_ID,composition,predict_spec) %>% # group  by xxx
  dplyr::summarize(
    biomass = sum(biomass * n_frames, na.rm = TRUE) / (1 * 125) # if not 3 videos corrections is done below with dens_factor
  ) %>%
  dplyr::mutate(
    biomass = biomass * extrapolation_factor,
    )

biomasses<-biomasses%>%dplyr::mutate(biomass=biomass*1000)

dd_ts_id<-biomasses

#fill up missing dates with biomass<-0

fill_dd<-expand.grid(sample_ID=unique(dd_ts_id$sample_ID),day=unique(dd_ts_id$day),predict_spec=unique(dd_ts_id$predict_spec))
complete_ts<-full_join(fill_dd,dd_ts_id,join_by(sample_ID,day,predict_spec))

complete_ts$biomass[is.na(complete_ts$biomass)]<-0
complete_ts<-complete_ts%>%dplyr::mutate(composition=sub("_.*", "", sample_ID))
complete_ts<-complete_ts %>%
  dplyr::mutate(temperature = sapply(strsplit(as.character(sample_ID), "_"), function(x) paste(x[3], x[4], sep = "-")))
complete_ts<- dplyr::mutate(complete_ts,nutrients = gsub(".*Nut(.*?)_.*", "\\1", sample_ID))

# Now remove wrong combinations of composition and predict_spec / predict_spec

complete_ts<- complete_ts %>%
  rowwise() %>%
  dplyr::filter(predict_spec %in% unlist(strsplit(composition, ""))) %>%
  ungroup()  
complete_ts<-dplyr::mutate(complete_ts,temperature=as.character(temperature),
                    nutrients=as.character(nutrients),
                    richness=nchar(composition))

complete_ts<-complete_ts%>%group_by(sample_ID,composition,day)%>%dplyr::mutate(tot_biomass=sum(biomass))
complete_ts<-complete_ts%>%dplyr::mutate(biom_contribution=biomass/tot_biomass)

df_biomass_mod <- complete_ts

complete_ts<-complete_ts%>%dplyr::mutate(temperature=paste0(temperature," Â°C"),
                                      nutrients=paste0(nutrients," g/L"))


# introduce slopes of 
names(df_slopes)[names(df_slopes)=="species_initial"]<-"predict_spec"

slope_ts<-full_join(dplyr::select(df_slopes,nutrients,predict_spec,temperature,slope),complete_ts)
slope_ts<-slope_ts%>%dplyr::mutate(w_slope=biom_contribution*slope,
                            sign=sign(slope))

slope_ts<-slope_ts%>%group_by(sample_ID,temperature,nutrients,richness,composition,day,tot_biomass)%>%dplyr::summarize(
  sum_w_slopes=abs(sum(w_slope)),
                   mean_abs_slope=mean(abs(slope)),
  sum_abs_slope=sum(abs(slope)),
  abs_sum_slope=abs(sum(slope)),
  symmetry=abs(sum(sign)))


slope_ts<-slope_ts%>%dplyr::mutate(richness=as.factor(richness))


##create new variable where it checks, where the last observation =0 is; with complete_ts
aggr_ts <- slope_ts %>%
  group_by( sample_ID) %>%
  arrange(day) %>%
  mutate(
    # Create a flag for non-zero tot_biomass
    non_zero_biomass = tot_biomass != 0,
    # Find the last non-zero day
    last_non_zero_day = ifelse(any(non_zero_biomass), max(day[non_zero_biomass], na.rm = TRUE), NA),
    # Find the first zero day after the last non-zero day
    first_zero_day = ifelse(
      !is.na(last_non_zero_day),
      min(day[!non_zero_biomass & day > last_non_zero_day], na.rm = TRUE),
      NA
    ),
    # Flag for days after the first zero day
    is_after_first_zero_day = ifelse(!is.na(first_zero_day), day > first_zero_day, FALSE)
  ) %>%
  ungroup()

aggr_ts<-aggr_ts%>%mutate(rep_var=sub("_[^_]+$", "", sample_ID))

biomass_ts<-aggr_ts%>%group_by(day,temperature,nutrients,richness)%>%summarize(tot_biom=mean(tot_biomass),se_tot_biom=sd(tot_biomass)/sqrt(as.numeric(length(tot_biomass))))


```


# Biomass

Let's have a look at the biomass dynamics in the different environmental treatments.

### tot biomass plot

```{r plot_biomass, fig.align="center", fig.height=8, fig.width=15}

plot_biomass<-ggplot(data=biomass_ts)+
  geom_ribbon(aes(x=day,y=tot_biom,fill=richness,color=richness,ymin=tot_biom-se_tot_biom,ymax=tot_biom+se_tot_biom),show.legend=F,alpha=0.5)+
  geom_line(method="loess",se=F,aes(x=day,y=tot_biom,color=richness),size=0.8)+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
   scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
  theme_classic()+
  #geom_text_repel( data=biomass_ts%>%dplyr::filter(day==58,tot_biom!=0),aes(x=day,y=tot_biom,group=composition,label = composition), size = 4,max.overlaps = 20) +
  facet_wrap(temperature~nutrients,scale="free_y")+
  theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12))+
  ylab(expression("Community biomass [mg ml"^-1 * "]"))
  
plot_biomass
```
 **Figure 1** : Community total biomass during the experiment in different environmental treatments. Different color represent richness levels.



# Main Results 

We now look at the main results of the experiment. We are going to look first at the effect of richness, temperature and nutrients on community temporal stability. Then, we are going to look at the relationship between divergence (original response diversity metric) and temporal stability. Finally, we are going to look at the relationship between response diversity and temporal stability.

In the whole analysis, we calculated the temporal stability of total community biomass as the inverse of the coefficient of variation (ICV) (i.e. 1/$\frac{\sigma}{\mu}$). 
```{r results='hide', echo=FALSE, warning=FALSE}
## discard all the rows that are part of time stretches where entire microcosms has (seemingly) gone extinct
#%>%dplyr::filter(is_after_first_zero_day==FALSE)

complete_aggr<-aggr_ts%>%group_by(composition,nutrients,temperature,sample_ID)%>%reframe(
  avg_w_sumslopes=mean(sum_w_slopes,na.rm = T),
  abs_sum_slope=mean(abs_sum_slope),
  magnitude=mean(mean_abs_slope),
  symmetry=mean(symmetry),
  sum_abs_slope=mean(sum_abs_slope),
  CV=sd(tot_biomass)/mean(tot_biomass),
  mean_biomass=mean(tot_biomass))

complete_aggr<-full_join(divergence_df,complete_aggr,by=join_by(composition,nutrients,temperature))%>%
  mutate(richness=as.factor(richness))




```

### Effect of T, N and R
```{r boxplots_TNR, results='hide', echo=FALSE, warning=FALSE, fig.align="center", fig.height=8, fig.width=14}
#### effects of temperature; nutrient and richness, now with complete time series

plot_T_complete<-ggplot(data=complete_aggr)+
  geom_boxplot(aes(y=log10(1/CV),x=temperature))+
  geom_jitter(aes(y=log10(1/CV),x=temperature))

plot_T_complete<-ggplot(data=complete_aggr)+theme_bw(base_size = 25)+
  geom_quasirandom(data= complete_aggr,aes(y=log10(1/CV), x=temperature, group=temperature, colour=as.factor(temperature)),
                                  dodge.width=2, size=2.5) + 

  xlab("Temperature regime")+
  labs(color="Temperature regime", tag = "(b)")+
  theme(legend.position = "none",axis.title.y = element_blank())+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) 


plot_N_complete<-ggplot(data=complete_aggr)+
  geom_boxplot(aes(y=log10(1/CV),x=nutrients))+
  geom_jitter(aes(y=log10(1/CV),x=nutrients,color=richness))

plot_N_complete<-ggplot(data=complete_aggr)+ theme_bw(base_size = 25)+
  geom_quasirandom(data= complete_aggr,aes(y=log10(1/CV), x=nutrients, group=nutrients, colour=as.factor(nutrients)),
                                  dodge.width=2, size=2.5) + 

  xlab("Nutrients")+
  theme(legend.position = "none",axis.title.y = element_blank())+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) + labs(tag = "(c)")

plot_R_complete<-ggplot(data=complete_aggr)+
  geom_boxplot(aes(y=log10(1/CV),x=richness))+
  geom_jitter(aes(y=log10(1/CV),x=richness))

plot_R_complete<-ggplot(data=complete_aggr)+theme_bw(base_size = 25)+
  geom_quasirandom(data= complete_aggr,aes(y=log10(1/CV), x=richness, group=richness, colour=as.factor(richness)),
                                  dodge.width=2, size=4) + 

  
  
  xlab("Richness")+
  theme(legend.position = "none",
        axis.title.y = element_blank())+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) + labs (tag = "(a)") 

combined_plot<-plot_R_complete/
(plot_T_complete+
plot_N_complete)

wrap_elements(combined_plot) +
  labs(tag = "Temporal stability\nlog(mean/s.d.)")+
  theme(
    plot.tag = element_text(size = rel(2.5), angle = 90),
    plot.tag.position = "left"
  )

# expression(atop("Temporal stability", log[10]("mean/s.d.")))



```
**Figure 2**: Effects of richness (a), temperature (b), and nutrients (c) on community total biomass temporal stability.



We can see that richness does not have a clear effect on community temporal stability, while stability was higher at lower temperature, and nutrients increased community temporal stability.

### Effect of Divergence

We look at the relationship between divergence (our original response diversity metric) and stability

```{r divergence_CV, results='hide', echo=FALSE, warning=FALSE, fig.align="center", fig.height=10, fig.width=16}

plot_CV_divergence<-complete_aggr%>%ggplot(aes(x=divergence,y=log10(1/CV),color=richness))+
  geom_point()+
  geom_smooth(method="lm",aes(x=divergence,y=log10(1/CV),color=richness),show.legend=F)+theme_classic()+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)+
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) +
    theme(
    axis.title.x = element_text(size = 25),
    axis.title.y = element_text(size = 25),
    axis.text = element_text(size = 14),                      # Axis text size             # Facet label text size
    legend.title = element_text(size = 20),                   # Legend title size
    legend.text = element_text(size = 20),                     # Legend text size
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 22)) +
  facet_wrap(~richness, labeller = as_labeller(function(x) paste0("richness = ", x)))+
  ylab("Temporal stability\nlog(mean/s.d.)")+
  xlab("divergence") 


plot_CV_divergence

```
**Figure 3**: Relationship between Divergence and temporal stability of total community biomass.



Divergence is positively related to temporal stability, suggesting that response diversity promotes stability. However, the relationship between divergence and stability becomes weaker as richness increases. We think that this is due to divergence considering only the responses of the 2 most "responding" species. Thus, when species richness increases, disregarding the responses of the other species in the community except the 2 responding the most makes the relationship between response diversity and stability weaker. 

This is why, after running the experiment, we developed another metric to measure response diversity, which we called **balance**, and that is presented in the main text of the publication. 
Balance has several desirable features that makes it a more suitable metric than divergence: Independence of richness, higher predictive power, and accounts for the responses of all species in the community (as opposed to divergence that accounts for only the 2 most "responding" species).

Here, we provide extensive evidence of why balance is a better metric to measure response diversity than divergence, and thus justifying focusing the analysis around balance.

# Comparing Divergence and Balance

We first compare how well divergence and balance predict stability (predictive power). 

```{r results='hide', echo=FALSE, warning=FALSE, message=FALSE}
library(broom)
library(kableExtra)

complete_aggr <- complete_aggr %>% mutate(stability = 1/CV) %>% 
  dplyr::rename(balance_f = abs_sum_slope,
                balance_r = avg_w_sumslopes)



# summary(lm_full)
# anova(lm_full)
```

## Balance


```{r model_check1, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}
# 

mod1 <- lm(data=complete_aggr,log10(stability)~log10(balance_f))

```



## Divergence
```{r model_check2, include=TRUE, echo=TRUE, fig.align="center", fig.height=9, fig.width=12}
mod2 <- lm(data=complete_aggr,log10(stability)~(divergence))


```



**Table 1**: Comparision of model performance of divergence and balance as predictors of stability. Model 1 has balance as predictor and model 2 has divergence as predictor.
```{r}
# compare performance tables of mod1 and mod2 specifying 
performance(mod1) %>% 
  bind_rows(performance(mod2), .id = "model") %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

A model with Balance as predictor performs better than one with divergence as predictor, and it explains more of the variance in stability than divergence.



Moreover, from **Figure 3**, it looks like divergence declines in performance as richness increases. Let's test this analytically.
To do than we build a linear model having stability as response variable and either log10(balance) or divergence as predictor for each richness level. We then extract the R squared of the models and their *standardised* estimates. (standardised estimates were calculated centering divergence and balance using the function scale()).

```{r include = TRUE, echo=TRUE}
# getting model estimates for each richness level
lm_divergence_richness_E <- complete_aggr %>%
  nest(data = -richness) %>%
  mutate(
    model = map(data, ~ lm(log10(stability) ~ scale(divergence), data = .x)),
    results = map(model, broom::tidy)
  ) %>%
  unnest(results) %>% dplyr::filter(term=="scale(divergence)") 


# getting model R squared for each richness level

lm_divergence_richness_R <- complete_aggr %>%
  nest(data = -richness) %>%
  mutate(
    model = map(data, ~ lm(log10(stability) ~ scale(divergence), data = .x)),
    results = map(model, broom::glance)
  ) %>%
  unnest(results) 

lm_divergence_richness_R
```


```{r include = TRUE, echo=TRUE}

# getting model estimatesf or each richness level
lm_balance_richness_E <- complete_aggr %>%
  nest(data = -richness) %>%
  mutate(
    model = map(data, ~ lm(log10(stability) ~ scale(log10(balance_f)), data = .x)),
    results = map(model, broom::tidy)
  ) %>%
  unnest(results) %>% dplyr::filter(term=="scale(log10(balance_f))") 



# getting model R squared for each richness level
lm_balance_richness_R <- complete_aggr %>%
  nest(data = -richness) %>%
  mutate(
    model = map(data, ~ lm(log10(stability) ~ scale(log10(balance_f)), data = .x)),
    results = map(model, broom::glance)
  ) %>%
  unnest(results) 

lm_balance_richness_R
```


```{r R_squared, fig.align="center", fig.height=5, fig.width=15}
# plot how the r squared changes with richness for divergence and balance with legend and lines with diamond instead of points





a <- ggplot(data = lm_divergence_richness_R, aes(x = richness, y = r.squared, color = "Divergence")) +
  geom_point( shape = 18, cex = 5 )  +
  geom_point(data = lm_balance_richness_R, aes(x = richness, y = r.squared, color = "Balance"), shape = 18, cex = 5 ) +
  labs(x = "Richness", y = "R squared", color = "Model") +
  theme_minimal(base_size = 20) +
  scale_color_manual(values = c("Divergence" = "blue", "Balance" = "red"))+ labs(tag = "(a)")


# plot how the estinmates changes with richness for divergence and balance with legend and lines
b <- ggplot(data = lm_divergence_richness_E, aes(x = richness, y = estimate, color = "Divergence") ) +
  geom_point(shape = 18, cex = 5) +
  geom_point(data = lm_balance_richness_E, aes(x = richness, y = abs(estimate), color = "Balance"), shape = 18, cex = 5 ) +
  labs(x = "Richness", y = "Estimate", color = "Model") +
  theme_minimal(base_size = 20) +
  scale_color_manual(values = c("Divergence" = "blue", "Balance" = "red")) + labs(tag = "(b)")

a + b

```
**Figure 4**: Performance comparison of divergence vs balance. In (a), the R squared of linear models for divergence and balance are shown for each richness level. In (b), the estimates of the linear models for divergence and balance are shown for each richness level.




We can see that the R squared of divergence as predictor of stability becomes smaller as richness increases, while the R squared of balance as predictor of stability does not (actually increases slightly). 



Now we build a linear model were stability is modeled as a function of balance and divergence. 
Then, we compared the variance explained by the full model compared to a model containing either only balance or only divergence.

```{r model_check3, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}
lm_div_balance <- lm(data=complete_aggr,log10(stability)~log10(balance_f)+divergence)

```



**model with only divergence**
```{r model_check4, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}
lm_div <- lm(data=complete_aggr,log10(stability)~divergence)

```




**model with only balance**
```{r model_check5, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}
lm_balance <- lm(data=complete_aggr,log10(stability)~log10(balance_f))

```




**Table 2**: Comparison of model performance of divergence, balance and both as predictors of stability. Model 1 has both balance and divergence as predictors, model 2 has divergence as predictor, and model 3 has balance as predictor.
```{r}
# compare performace tables of lm_div_balance, lm_div and lm_balance
performance(lm_div_balance) %>% 
  bind_rows(performance(lm_div), .id = "model") %>% 
  bind_rows(., performance(lm_balance), .id = "model") %>% 
  kable() %>% 
  kable_styling(full_width = F)

```





Type III anova table: a model with both balance and divergence as predictors is not significantly different from a model with only balance as predictor.
```{r include = TRUE, echo=TRUE}
anova(lm_div_balance,  lm_balance)
```




Type III anova table: a model with both balance and divergence as predictors is significantly better from a model with only divergence as predictor.
```{r include = TRUE, echo=TRUE}
anova(lm_div_balance,  lm_div)
```

Overall, balance explains more of the variance in stability than divergence, and there is virtually no difference between a model containing only balance and the full model.




**Interaction divergence and richness**

Richness had to transformed to numeric and to be centered to avoid collinearity with divergence

```{r model_check6, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}


lm_rich_div <- lm(data=complete_aggr,log10(stability)~divergence*scale(as.numeric(richness)))

```




Type III anova table
```{r include = TRUE, echo=TRUE}
anova(lm_rich_div)
```


Divergence significantly interact with richness, suggesting that the relationship between divergence and stability changes with richness. 
While an ideal metric of response diversity should be independent of richness.



We repeat the same model using balance instead of divergence.
```{r model_check7, fig.align="center", fig.height=9, fig.width=12, include=TRUE, echo=TRUE}
lm_rich_balance <- lm(data=complete_aggr,log10(stability)~log10(balance_f)*scale(as.numeric(richness)))

```





Type III anova table
```{r include = TRUE, echo=TRUE}
anova(lm_rich_balance)

```

Balance does not significantly interact with richness, suggesting that the relationship between balance and stability is stable across richness levels.



Finally, we assess variable importance using the relative importance of predictors in the full model.
We use the package vip (https://cran.r-project.org/web/packages/vip/vignettes/vip.html) to calculate the relative importance of predictors in the full model.
The function vip::vip for multiple linear regression, or linear models (LMs), uses the absolute value of the -statistic  as a measure of VI.
Motivation for the use of the associated ð‘¡-statistic is given in Bring (1994) [https://www.tandfonline.com/doi/abs/10.1080/00031305.1994.10476059].

```{r vip1, fig.align="center", fig.height=4, fig.width=8, include=TRUE, echo=TRUE}
vip::vip(lm_div_balance)
```
**Figure 5**: Variable importance in the model including both balance and divergence as predictors of stability.


We believe that the extensive evidence here provided justifies focusing the analysis around balance, and not divergence, as a metric of response diversity.
We will thus only look at balance for the rest of the analysis. 




# Effect RD

We are now going to look at how response diversity (balance) affected temporal stability of total community biomass. We are going to look at the relationship between fundamental balance (so based only on species response surfaces measured in monoculture), an realised balance (measured accounting for species contribution to balance).

This is fundamentally testing our most important hypothesis.

```{r effect_RD, results='hide', echo=FALSE, warning=FALSE, fig.align="center", fig.height=10, fig.width=20}

balance_dd<-complete_aggr%>%dplyr::select(balance_f,richness,CV)%>%
  cbind(type="fundamental")%>%mutate(balance_f=balance_f/as.numeric(richness))
names(balance_dd)[names(balance_dd)=="balance_f"]<-"balance"

weighted_balance_dd<-complete_aggr%>%dplyr::select(balance_r,richness,CV)%>%
  cbind(type="realised")
names(weighted_balance_dd)[names(weighted_balance_dd)=="balance_r"]<-"balance"

main_r_dd<-rbind(balance_dd,weighted_balance_dd)

plot_main <- main_r_dd %>%
  ggplot(aes(x = log10(balance), y = log10(1/CV), color = type)) +
  geom_point(aes(x = log10(balance), y = log10(1/CV))) +
  geom_smooth(method = "lm", aes(x = log10(balance), y = log10(1/CV)),show.legend=F) +
  theme_classic() +
  scale_color_viridis_d(option = "inferno", begin = 0.3, end = 0.6) +
  scale_x_continuous(
    breaks = log10(c(0.0025,0.01, 0.04, 0.16, 0.64)),
    labels = c("0.0025","0.01", "0.04", "0.16", "0.64")
  ) +
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) +
  ylab("Temporal stability\nlog(mean/s.d.)")+
  xlab("log(balance)") +
 theme(
    axis.title.x = element_text(size = 25),
    axis.title.y = element_text(size = 25),
    axis.text = element_text(size = 14),                      # Axis text size             # Facet label text size
    legend.title = element_text(size = 20),                   # Legend title size
    legend.text = element_text(size = 20),                     # Legend text size
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 22)) +
  labs(color = "balance") +  
  facet_wrap(~richness, labeller = as_labeller(function(x) paste0("richness = ", x)))

plot_main
```
**Figure 6**: Effects of fundamental and realised response diversity (measured as balance) on total community biomass temporal stability.


We can see that balance is always negatively related to temporal stability, which means that response diversity promotes stability across richness levels. Interestingly, we see that there is little difference between fundamental and realised balance. Yet, as the richness increases, the relationship between realised balance and stability becomes steeper compared to fundamental balance. 



# Linear models


## Model: Fundamental balance

First we analyze the effect of fundamental balance, temperature, nutrients and richness on biomass temporal stability using a linear model. 
balance was modelled as continuous variables, while richness, temperature and nutrients were modelled as categorical variables. balance and stability were log-transformed to meet the assumptions of linear models.


```{r include=TRUE, echo=TRUE}
# create a new dataframe with richness, nutrients, and temperature as numeric variables, and thus remove units from nutrients and temperature and convert temperature to 1, 2, 3 

lm_full<-lm(data=complete_aggr,log10(stability)~log10(balance_f)+(richness)+(nutrients)+(temperature))


```






```{r include=TRUE, echo=TRUE}
summary(lm_full)

```

```{r include=TRUE, echo=TRUE}
anova(lm_full)

```

A linear model was fitted to examine the effects of resource balance, richness, nutrients, and temperature on community stability (measured as logâ‚â‚€(stability)). The model explained a significant portion of the variance (Adjusted RÂ² = 0.5115, F(7, 235) = 37.2, p < 2.2e-16).

The intercept of the model was estimated at -0.349 (SE = 0.028, p < 2e-16), indicating the baseline logâ‚â‚€(stability) when all predictor variables are at their reference levels.

Among the predictors, logâ‚â‚€(balance) showed a significant negative effect on stability (Estimate = -0.054, SE = 0.016, p = 0.0009). This suggests that as balance increases (more imbalance), stability tends to decrease.

In terms of richness, communities with three species (richness3) showed a significant decrease in stability compared to the reference level (richness2; ð›½=âˆ’0.042Â±0.018Î²=âˆ’0.042Â±0.018; t=âˆ’2.25, p=0.025). In contrast, communities with four species (richness4) did not differ significantly from the reference level (ð›½=âˆ’0.012Â±0.019Î²=âˆ’0.012Â±0.019; t=âˆ’0.67, p=0.51).
In contrast, communities with four species (richness4) did not differ significantly from the reference level (ð›½=âˆ’0.012Â±0.019Î²=âˆ’0.012Â±0.019; t=âˆ’0.67, p=0.51).


Nutrient concentration also had a significant positive effect on stability, with estimates for 0.35 g/L (Estimate = 0.180, SE = 0.019, p < 2e-16) and 0.75 g/L (Estimate = 0.212, SE = 0.019, p < 2e-16) indicating increased stability with higher nutrient levels.

Finally, temperature regimes showed a significant effect on stability. Both 22â€“25 Â°C (Estimate = -0.078, SE = 0.019, p = 3.81e-05) and 25â€“28 Â°C (Estimate = -0.098, SE = 0.025, p = 8.44e-05) significantly reduced stability when compared to the baseline (18â€“21 Â°C).


In summary, our findings show that temporal stability is significantly influenced by response diversity (balance), nutrient concentration, and temperature, with higher nutrient concentrations enhancing stability and higher temperatures reducing it. However, species richness was not a significant determinant of stability within the conditions of this study.

Prepare publication-ready table 

Summary table

```{r results='hide', echo=FALSE, warning=FALSE, message=FALSE}
# Tidy up model results and calculate 95% CI
model_summary <- lm_full %>%
  broom::tidy(conf.int = TRUE) %>%    # Adds 95% CI columns
  dplyr::mutate(
    p.value = formatC(p.value, format = "e", digits = 2) # Format p-value for scientific notation
  ) %>%
  dplyr::select(term, estimate, conf.low, conf.high, statistic, p.value) # Select relevant columns

# Create a publication-ready table with conditional bold formatting
table1 <- model_summary %>%
  kable("html", col.names = c("Term", "Estimate", "Lower 95% CI", "Upper 95% CI", "t value", "p-value"),
        digits = 3, align = "c") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
    row_spec(which(as.numeric(model_summary$p.value) < 0.05), bold = TRUE)  


```


**Table 2**: Linear model results for the effects of balance, richness, nutrients, and temperature on community stability. Estimates are presented with 95% confidence intervals and p-values. Significant results are highlighted in bold.
```{r}
table1
```


**Table 3**:Pairwise contrasts
```{r}
# produce publication ready table using gtsummary::tbl_regression

# Generate the regression table with enhanced styling

gtsummary::tbl_regression(lm_full,
               add_estimate_to_reference_row = TRUE, # Adds reference values for categorical predictors
               add_pairwise_contrasts = TRUE) %>% 
  # Customize table elements
  gtsummary::modify_header(label = "**Predictor**", estimate = "**Estimate**", conf.int = "**95% CI**", p.value = "**p-value**") %>%
  gtsummary::modify_footnote(everything() ~ NA) %>% # Remove default footnotes for clean look
  gtsummary::modify_spanning_header(c("estimate",  "p.value") ~ "**Linear Regression Results**") %>% # Title
  gtsummary::bold_labels() %>%
  gtsummary:: bold_p() %>% 
  gtsummary::as_gt() 

```

```{r fig.align="center", fig.height=6, fig.width=18}
# produce publication ready anova table using gtsummary
library(gt)
# Get ANOVA table using car::Anova for Type II sum of squares
anova_table <- car::Anova(lm_full, type = 3)

# Convert to tidy format
anova_tidy <- broom::tidy(anova_table)

# Display the tidy ANOVA table using gt with formatted p-values and adjusted size
anova_tidy %>%
  gt() %>%
  tab_header(title = "Type III ANOVA Table for Linear Model") %>%
  cols_label(
    term = "Term",
    sumsq = "Sum of Squares",
    df = "DF",
    statistic = "F Statistic",
    p.value = "p-value"
  ) %>%
  fmt_number(
    columns = vars(p.value),
    decimals = 3
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = vars(p.value),
      rows = p.value < 0.05
    )
  ) %>%
  tab_options(
    table.width = px(800),            # Adjust table width (e.g., 400px)
    table.font.size = px(20),        # Adjust font size (e.g., 12px)
    data_row.padding = px(10)         # Adjust row padding (e.g., 4px for more compact rows)
  )



```

### sum vs. weighted_sum

We now look at how fundamental and realised balance are related to each other. 

```{r Cor_sum_weighted_sum, results='hide', warning=FALSE, fig.align="center", fig.height=6, fig.width=8}

richness2<-complete_aggr%>%dplyr::filter(richness==2)
cor_r2<-cor.test(log10(richness2$balance_f),log10(richness2$balance_r))$estimate

richness3<-complete_aggr%>%dplyr::filter(richness==3)
cor_r3<-cor.test(log10(richness3$balance_f),log10(richness3$balance_r))$estimate

richness4<-complete_aggr%>%dplyr::filter(richness==4)
cor_r4<-cor.test(log10(richness4$balance_f),log10(richness4$balance_r))$estimate


plot_cor<-ggplot(data=complete_aggr,aes(x=log10(balance_f),y=balance_r%>%log10(
)))+
  geom_point(aes(color=richness))+
  theme_bw()+
   scale_y_continuous(
    breaks = log10(c(0.0025,0.01, 0.04, 0.16, 0.64)),
    labels = c("0.0025","0.01", "0.04", "0.16", "0.64")
  ) +
  scale_x_continuous(
    breaks = log10(c(0.01, 0.04, 0.16, 0.64)),
    labels = c("0.01", "0.04", "0.16", "0.64")
  ) +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   geom_abline(slope = 1, intercept = 0, color = "black")+
   xlab(expression(log(balance)["fund"] )) +
  ylab(expression(log(balance)["real"] ))+
  facet_wrap(~richness, labeller = as_labeller(function(x) paste0("richness = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8) 

plot_cor





```
**Figure 7**: Relationship between fundamental and realised balance. The black line represents the 1:1 relationship between fundamental and realised balance.



# Asynchrony
Response diversity (aka balance) has been suggested as a mechanism that promotes temporal stability of community biomass by promoting species asynchrony.

We thus calculated the asynchrony index suggested by Gross et al. (2014)[https://www.journals.uchicago.edu/doi/epdf/10.1086/673915] to calculate the effect of asynchrony on temporal stability and to see how reponse diversity relate to asynchrony.
The index ranges between -1 and 1, with -1 indicating perfect asyncrony and 1 being perfectly synchronous, and 0 indicating random variation.


```{r echo=F, warning=FALSE, results='hide'}

#filter out completely extinct microcosms


async_df<-complete_ts%>%dplyr::mutate(rep_var=sub("_[^_]+$", "", sample_ID))


async_Gross <- async_df %>% group_by(composition,sample_ID) %>%  
  do(synchrony_Gross = synchrony(., "day", "predict_spec", 
                              "biomass", metric = "Gross"))
async_Gross<-dplyr::mutate(async_Gross,synchrony_Gross=synchrony_Gross%>%unlist())

async_Loroeau <- async_df %>% group_by(composition,sample_ID) %>%  
  do(synchrony_L = synchrony(., "day", "predict_spec", 
                              "biomass", metric = "Loreau"))
async_Loroeau<-dplyr::mutate(async_Loroeau,synchrony_Loreau=synchrony_L%>%unlist())

async_aggr<-full_join(async_Gross,complete_aggr,join_by(sample_ID,composition))

async_aggr<-full_join(async_aggr,async_Loroeau,join_by(sample_ID,composition))

async_aggr_f<-async_aggr%>%dplyr::filter(nutrients!="0.01 g/L")
async_aggr<-async_aggr%>%dplyr::mutate(rep_var=sub("_[^_]+$", "", sample_ID))
```




### Plot stability vs. Asynchrony Gross
```{r async_plots, fig.align="center", fig.height=6, fig.width=12}
plot_asynch_CV_G<-ggplot(data=async_aggr,aes(x=-synchrony_Gross,y=log10(1/CV),color=nutrients))+
  geom_point()+
  geom_smooth(method="lm",show.legend=F)+
  theme_classic()+
  scale_y_continuous(
    breaks = log10(c(0.1,0.2, 0.4, 0.8, 1.6, 3.2)),
    labels = c("0.1","0.2"," 0.4", "0.8", "1.6", "3.2")
  ) +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   ylab("Temporal stability\nlog(mean/s.d.)")+
  xlab("Asynchrony")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)




plot_asynch_CV_G

ggsave("figures_ms/fig.4.png", plot = plot_asynch_CV_G, width = 12, height = 6, dpi = 600)


```
**Figure 8**: Relationship between temporal stability and asynchrony (Gross) divided by nutrient level.

### Plot Asynchrony Gross vs fundamental balance

```{r async,  fig.align="center", fig.height=6, fig.width=12}

plot_asynch_CV_G<-ggplot(data=async_aggr,aes(x=log10(balance_f),y=-synchrony_Gross,color=nutrients))+
  geom_point()+
  geom_smooth(method="lm",show.legend=F)+
  theme_classic()+
  scale_x_continuous(
    breaks = log10(c(0.0025,0.01, 0.04, 0.16, 0.64)),
    labels = c("0.0025","0.01", "0.04", "0.16", "0.64")
  ) +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   xlab(expression(log(balance)["fund"] )) +
  ylab("Asynchrony")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)

plot_asynch_balance
ggsave("figures_ms/fig.5.png", plot = plot_asynch_balance, width = 12, height = 6, dpi = 600)

```
**Figure 9**: Relationship between asynchrony (Gross) and fundamental balance divided by nutrient level.


# SEM 


Now, we use a structural equation model (SEM) to explore how stability is influenced by asynchrony, temperature, nutrient levels, balance, and richness, with asynchrony also modeled as dependent on balance, nutrients, and richness.

```{r echo=FALSE, warning=FALSE, results='hide'}
# Ensure the data is ungrouped before applying transformations
sem_aggr <- async_aggr %>%
  ungroup() %>%  # Ensure there is no grouping
  mutate(
    log_balance_f = log10(balance_f),
    stability = log10(1 / CV),
    richness = as.numeric(richness),
    temperature=temperature,
    asynchrony_Gross= (-synchrony_Gross)
    #Keep it as an ordered factor
  )



sem_aggr$nutrients[sem_aggr$nutrients=="0.01 g/L"]<-0.01
sem_aggr$nutrients[sem_aggr$nutrients=="0.35 g/L"]<-0.35
sem_aggr$nutrients[sem_aggr$nutrients=="0.75 g/L"]<-0.75

sem_aggr$temperature[sem_aggr$temperature=="18-21 Â°C"]=1
sem_aggr$temperature[sem_aggr$temperature=="22-25 Â°C"]=2
sem_aggr$temperature[sem_aggr$temperature=="25-28 Â°C"]=3


#correct balance for magnitude
# the effect of magnitude goes down, the more divergence there is

# Load the lavaan package
library(lavaan)

```

```{r include=TRUE, echo=TRUE}


model1B <- '
  stability ~ asynchrony_Gross
  +temperature
  +nutrients
  +log_balance_f+
  richness

  
  asynchrony_Gross ~ log_balance_f
  +nutrients
  +richness
'


# Fit the model

fit1B <- sem(model1B, estimator="MLM",meanstructure = TRUE,data = sem_aggr%>%dplyr::filter(!is.na(synchrony_Gross)))


# Summarize the results
summary(fit1B, standardized = TRUE,rsquare=T, fit.measures = TRUE)

```
**Model Fit**

The model fit indices suggest a good fit:

Comparative Fit Index (CFI) = 0.998 and Tucker-Lewis Index (TLI) = 0.986, both indicating a good fit as values close to 1 are considered strong.
Root Mean Square Error of Approximation (RMSEA) = 0.047 (with robust RMSEA at 0.051) and Standardized Root Mean Square Residual (SRMR) = 0.012. These values indicate a good fit, with RMSEA and SRMR values below 0.05 generally preferred.


Interpretation of Pathways


**Stability**:

*Asynchrony*: Positive and highly significant effect on stability, suggesting that asynchrony (indicating lack of synchrony or compensatory dynamics) is associated with greater stability.

*Temperature*: Negative effect, where higher temperature values correlate with lower stability, potentially due to physiological stress or disruption in community dynamics at higher temperatures.

*Nutrients*: Positive and highly significant, suggesting that greater nutrient availability enhances stability, possibly through support for higher productivity or resource buffering.

*balance*: Negative and significant effect, where greater balance reduces stability.
Richness: Not significant, indicating that within this model, richness does not have a notable effect on stability.


**Asynchrony**:

*balance*: Negative and significant, suggesting that greater balance reduces asynchrony.

*Nutrients*: Negative and highly significant effect, indicating that higher nutrient concentrations are associated with lower asynchrony, possibly due to homogenizing effects of nutrient availability.

*Richness*: Negative and significant, where increased richness is associated with reduced asynchrony, possibly indicating increased interactions or overlap in resource use among species.

**Explained Variance**

*Stability*: The model explains 57% of the variance in stability, suggesting a substantial amount of stability is accounted for by these factors.

*Asynchrony*: The model explains 30.6% of the variance in asynchrony, indicating that while balance, nutrients, and richness contribute, other factors may also play a role in driving asynchrony.

**Summary**

This SEM model demonstrates that stability in the ecosystem is positively associated with asynchrony and nutrient levels, but negatively associated with temperature and balance. Interestingly, species richness has no direct impact on stability but does reduce asynchrony, indicating indirect complexity in the stability-dynamics relationship. This highlights the role of environmental and community factors in ecosystem stability, with asynchrony serving as a crucial intermediary in maintaining stability in fluctuating conditions.

```{r SEM, fig.cap = 'SEM.', fig.align="center", fig.height=6, fig.width=8}
knitr::include_graphics(("SEM.png"))

```

**Figure 10**: Structural equation model (SEM) of the relationship between fundamental balance, asynchrony, richness, nutrients, temperature and temporal stability. The model shows that fundamental balance has a negative effect on asynchrony, which in turn has a positive effect on temporal stability. The model also shows that fundamental balance has a direct negative effect on temporal stability. Temperature has a direct negative effect on temporal stability, while nutrients have a direct positive effect on temporal stability. Richness has a direct negative effect on asynchrony, but no direct effect on temporal stability. 




# Species Interactions
```{r results='hide', echo=FALSE, warning=FALSE, message=FALSE}
interactions_df <- read_csv("Data/interactions_df_var_thetas.csv")

int_aggr<-interactions_df%>%group_by(theta,sample_ID)%>%
  summarize(mean_int_strength=abs(mean(coefficient_value,na.rm=T)),
            mean_interaction=mean(coefficient_value,na.rm=T),
            sum_int_strength=sum(abs(coefficient_value),na.rm=T))


int_aggr<-int_aggr%>%group_by(theta)%>%full_join(async_aggr,join_by(sample_ID))%>%ungroup()

int_aggr$mean_int_strength[is.na(int_aggr$mean_int_strength)]=0
int_aggr$mean_interaction[is.na(int_aggr$mean_interaction)]=0
int_aggr$sum_int_strength[is.na(int_aggr$sum_int_strength)]=0

int_aggr$theta[is.na(int_aggr$theta)]="none"


```


```{r include=TRUE, echo=TRUE}
lm_M_int<-lm(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),log10(stability)~log10(balance_f)+nutrients+temperature+(richness)+mean_interaction)
```




```{r include=TRUE, echo=TRUE}
summary(lm_M_int)
```


```{r include=TRUE, echo=TRUE}

anova(lm_M_int)

```

```{r}
vip::vip(lm_M_int)
```


```{r include=TRUE, echo=TRUE}
# create new variable describing the level of balance_f. Categories should be low, medium_low, medium_high, high and based on 25% quantiles
int_aggr<-int_aggr%>%mutate(balance_level=ifelse(balance_f<quantile(balance_f,0.25),"low",
                                                ifelse(balance_f<quantile(balance_f,0.5),"medium_low",
                                                       ifelse(balance_f<quantile(balance_f,0.75),"medium_high","high"))))


# create variable low_balance that is 1 if balance_level is low or medium_low and 0 otherwise 
int_aggr%>%dplyr::filter(theta%in%c("none","var"))%>%dplyr::mutate(low_balance=ifelse(balance_level%in%c("low","medium_low"),1,0))%>%
  dplyr::mutate(neg_syn=ifelse(synchrony_Gross<0,1,0))%>%
  dplyr::summarize(perc_neg_syn=sum(neg_syn)/n(),perc_neg_int=sum(low_balance)/n())


```



```{r include=TRUE, echo=TRUE}
# calculate percentage of negative mean_interaction associated with negative synchrony_gross
int_aggr%>%dplyr::filter(theta%in%c("none","var"))%>%dplyr::mutate(neg_int=ifelse(mean_interaction<0,1,0))%>%
  dplyr::mutate(neg_syn=ifelse(synchrony_Gross<0,1,0))%>%
  dplyr::summarize(perc_neg_syn=sum(neg_syn)/n(),perc_neg_int=sum(neg_int)/n())

```


```{r interactions,  fig.align="center", fig.height=6, fig.width=12}



plot_int_asy<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_interaction,y=-synchrony_Gross,color=nutrients))+
  geom_point()+
  geom_smooth(method="lm",show.legend=F)+
  theme_classic() +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   xlab("mean interaction coefficient") +
  ylab("Asynchrony")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)




plot_int_asy
```
**Figure 11**: Relationship between mean interaction strength and asynchrony (Gross) divided by nutrient level.


```{r interactions_stab,  fig.align="center", fig.height=6, fig.width=12}



plot_int_stab<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_interaction,y=log10(stability),color=nutrients))+
  geom_point()+
  geom_smooth(method="lm",show.legend=F)+
  theme_classic() +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   xlab("mean interaction coefficient") +
  ylab("Stability")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)




plot_int_stab
```

**Figure 12**: Relationship between mean interaction strength and stability divided by nutrient level.


```{r interactions_asynchrony,  fig.align="center", fig.height=6, fig.width=12}



plot_int_strength<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_int_strength,y=-synchrony_Gross,color=nutrients))+
  geom_point()+
  geom_smooth(method="lm",show.legend=F)+
  theme_classic() +
   theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 12),legend.position="none") +
   xlab("mean interaction strength") +
  ylab("Asynchrony")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_color_viridis_d(option = "inferno", begin = 0.2, end = 0.8)




plot_int_strength
```

**Figure 13**: Relationship between mean interaction strength and asynchrony (Gross) divided by nutrient level.

```{r interactions_density,  fig.align="center", fig.height=10, fig.width=30}
# plot distribution of mean_interaction faceted by richness, not by nutrients, and use distribution plot with median value

plot_int_temperature<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_interaction))+
  geom_density(aes(fill=temperature),alpha=0.5)+
    geom_vline(xintercept = 0,linetype="dashed")+
  theme_classic() +
   theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 20),legend.position="none") +
   xlab("mean interaction coefficient") +
  ylab("density")+
  facet_wrap(~temperature, labeller = as_labeller(function(x) paste0("temperature = ", x)))+
  scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.8) + labs(tag = "(a)")

plot_int_nutrients<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_interaction))+
  geom_density(aes(fill=nutrients),alpha=0.5)+
    geom_vline(xintercept = 0,linetype="dashed")+
  theme_classic() +
   theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 20),legend.position="none") +
   xlab("mean interaction coefficient") +
  ylab("density")+
  facet_wrap(~nutrients, labeller = as_labeller(function(x) paste0("nutrients = ", x)))+
  scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.8) + labs(tag = "(b)")


plot_int_richness<-ggplot(data=int_aggr%>%dplyr::filter(theta%in%c("none","var")),aes(x=mean_interaction))+
  geom_density(aes(fill=richness),alpha=0.5)+
  geom_vline(xintercept = 0,linetype="dashed")+
  theme_classic() +
   theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        strip.background = element_rect(fill = "grey80", color = NA),  
    strip.text = element_text(size = 20),legend.position="none") +
   xlab("mean interaction coefficient") +
  ylab("density")+
  facet_wrap(~richness, labeller = as_labeller(function(x) paste0("richness = ", x)))+
  scale_fill_viridis_d(option = "inferno", begin = 0.2, end = 0.8) + labs(tag = "(c)")


plot_int_temperature + plot_int_nutrients + plot_int_richness 



```
**Figure 14**: Distribution of mean interaction coefficient faceted by temperature, nutrients, and richness. 

```{r}
summary(lm(formula = (synchrony_Gross) ~ log10(balance_f) + nutrients + 
    richness + temperature, data = int_aggr))
```

Is this evidence for facilitation at higher richness?
```{r}

summary(lm(formula = (synchrony_Gross) ~ mean_interaction + log10(balance_f) + nutrients + 
    richness + temperature, data = int_aggr), type = 2)
```


# SEM2 
```{r include=TRUE, echo=TRUE} 
sem_aggr2 <- int_aggr %>%
  ungroup() %>%  # Ensure there is no grouping
  mutate(
    log_balance_f = log10(balance_f),
    stability = log10(1 / CV),
    richness = as.numeric(richness),
    temperature=temperature,
    asynchrony_Gross= (-synchrony_Gross)
    #Keep it as an ordered factor
  )


model1B <- '
  stability ~ asynchrony_Gross
  +nutrients
  +log_balance_f+
  richness +
  mean_interaction+
  temperature

  
  asynchrony_Gross ~ log_balance_f
  +nutrients+
  richness+
  mean_interaction

'


# Fit the model

fit1B <- sem(model1B, estimator="MLM",meanstructure = TRUE,data = sem_aggr2%>%dplyr::filter(!is.na(asynchrony_Gross), theta%in%c("none","var")))


# Summarize the results
summary(fit1B, standardized = TRUE,rsquare=T, fit.measures = TRUE)

```

```{r SEM2, fig.cap = 'SEM.', fig.align="center", fig.height=6, fig.width=8}
knitr::include_graphics(("SEM2.png"))

```

**Figure 15**: Structural equation model (SEM) of the relationship between fundamental balance, asynchrony, richness, species interactions, nutrients, temperature and temporal stability.  

**Model Fit **

Chi-Square Test: The model test statistic for the user model (ðœ’2=0.661,df=1, p=0.416) suggests that the model fits the data well, as the p-value is not significant. This indicates no significant difference between the observed and predicted covariance matrices.

Comparative Fit Index (CFI) and Tucker-Lewis Index (TLI): Both indices are very close to 1 (CFI = 1.000, TLI = 1.012), indicating excellent model fit.

RMSEA: The RMSEA is 0, with a 90% confidence interval from 0 to 0.158. The low RMSEA, along with p-values for tests of close fit (RMSEA â‰¤ 0.05), further supports a well-fitting model.

SRMR: The SRMR value of 0.006 indicates a good fit, as values below 0.08 are generally acceptable.


**Regression Paths**

**Predictors of Stability**

*Asynchrony_Gross*: Positively associated with stability (Î²=0.206, p<0.001, standardized = 0.421), suggesting that greater asynchrony among species contributes to higher stability.

*Nutrients*: Significant positive association with stability (Î²=0.145,p<0.001, standardized = 0.707), indicating that increased nutrient levels promote stability.

*Log(Balance)*: A small but significant negative association (Î²=âˆ’0.027, p=0.019, standardized = -0.112), suggesting that greater balance in response diversity slightly decreases stability.

*Richness*: Not a significant predictor (Î²=0.009, p=0.373).

*Mean Interaction*: Approaches significance (Î²=0.043, p=0.056), suggesting a potential weak positive influence on stability.

*Temperature*: Shows a significant negative association (Î²=âˆ’0.051, p<0.001, standardized = -0.250), indicating that higher temperatures tend to reduce stability.


**Predictors of Asynchrony_Gross**

*Log(Balance)*: Shows a negative relationship with asynchrony (Î²=âˆ’0.075, p=0.007), suggesting that higher balance is associated with lower asynchrony among species.

*Nutrients*: Significant negative effect (Î²=âˆ’0.180, p<0.001, standardized = -0.430), indicating that higher nutrient levels reduce species asynchrony.

*Richness*: Negatively associated with asynchrony (Î²=âˆ’0.078, p<0.001), implying that greater species richness leads to less asynchrony.

*Mean Interaction*: A strong negative association with asynchrony (Î²=âˆ’0.272, p<0.001), suggesting that higher mean interaction values reduce species asynchrony.

**Variance and R-Squared**


Overall, the model suggests that stability is positively influenced by asynchrony and nutrient levels, while it decreases with higher temperatures and increased balance in species responses. Asynchrony itself is reduced by increased nutrients, richness, balance, and mean interaction levels, highlighting complex interactions between community structure and environmental factors that influence ecosystem stability.
